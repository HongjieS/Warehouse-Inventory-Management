{"ast":null,"code":"// src/parsers/worldFamousParser.js\nimport * as pdfjsLib from \"pdfjs-dist/build/pdf\";\nimport pdfWorker from \"pdfjs-dist/build/pdf.worker.entry\";\n\n// Ensure worker is properly configured\npdfjsLib.GlobalWorkerOptions.workerSrc = pdfWorker;\n\n/**\r\n * parsePDFWorldFamous(arrayBuffer)\r\n *  For World Famous / Ink Projects invoices\r\n */\nexport async function parsePDFWorldFamous(arrayBuffer) {\n  try {\n    const pdf = await pdfjsLib.getDocument({\n      data: arrayBuffer\n    }).promise;\n    let allText = \"\";\n    for (let i = 1; i <= pdf.numPages; i++) {\n      const page = await pdf.getPage(i);\n      const content = await page.getTextContent();\n\n      // Sort items by their vertical position (y) and then horizontal position (x)\n      const items = content.items.sort((a, b) => {\n        const yDiff = b.transform[5] - a.transform[5];\n        if (Math.abs(yDiff) < 2) {\n          // If y positions are close, sort by x\n          return a.transform[4] - b.transform[4];\n        }\n        return yDiff;\n      });\n\n      // Group items by their vertical position to form lines\n      let currentY = null;\n      let currentLine = [];\n      const lines = [];\n      for (const item of items) {\n        if (currentY === null || Math.abs(item.transform[5] - currentY) > 2) {\n          if (currentLine.length > 0) {\n            lines.push(currentLine.join(' '));\n          }\n          currentLine = [item.str];\n          currentY = item.transform[5];\n        } else {\n          currentLine.push(item.str);\n        }\n      }\n      if (currentLine.length > 0) {\n        lines.push(currentLine.join(' '));\n      }\n      allText += lines.join('\\n') + '\\n';\n    }\n\n    // Split into lines and filter out empty lines and headers\n    const lines = allText.split('\\n').filter(line => line.trim()).filter(line => !line.match(/^Page \\d+$/)).filter(line => !line.match(/^(Item|Description|Ordered|Rate|Amount)$/)).filter(line => !line.match(/^Total$/));\n    console.log('Filtered lines:', lines); // Debug logging\n\n    const results = [];\n    for (const line of lines) {\n      // Add debug logging to see exact line content with visible spaces\n      console.log('Processing line:', line.replace(/ /g, '·')); // Shows spaces as dots for debugging\n\n      // Match World Famous invoice format from the actual invoice\n      // Example: \"0 0 10 WFFMW1 Mt. Fuji Mixing White— World Famous Tattoo Ink — 1oz\"\n      const match = line.match(/^\\s*(\\d+)\\s+(\\d+)\\s+(\\d+)\\s+([A-Z0-9]+)\\s+(.*?)(?:\\s+\\$[\\d.,]+){0,2}\\s*$/);\n      if (match) {\n        const [, fulfilled, invoiced, qtyStr, itemCode, description] = match;\n        console.log('Matched components:', {\n          fulfilled,\n          invoiced,\n          qtyStr,\n          itemCode,\n          description\n        }); // Debug matched components\n        const quantity = parseInt(qtyStr.replace(/,/g, ''), 10);\n\n        // Extract size from description\n        let size = \"1oz\"; // default\n        const sizeMatch = description.match(/(?:^|\\s)(\\d+(?:\\/\\d+)?)\\s*(?:oz|ounce)(?:\\s|$)/i);\n        if (sizeMatch) {\n          size = sizeMatch[1] + \"oz\";\n        } else if (description.includes(\"2oz\")) {\n          size = \"2oz\";\n        } else if (description.includes(\"4oz\")) {\n          size = \"4oz\";\n        }\n\n        // Clean up color name\n        const color = description.replace(/—\\s*World Famous Tattoo Ink(?:\\s*—)?/gi, \"\").replace(/\\s*—\\s*/g, \" \") // Replace em dashes with spaces\n        .replace(/(?:^|\\s)(\\d+(?:\\/\\d+)?)\\s*(?:oz|ounce)(?:\\s|$)/gi, \" \").replace(/\\s*\\([^)]*\\)/g, \"\") // Remove any parenthetical notes\n        .replace(/\\s*\\[[^\\]]*\\]/g, \"\") // Remove any bracketed notes\n        .replace(/\\s*\\{[^}]*\\}/g, \"\") // Remove any curly braced notes\n        .replace(/\\s*\\$[\\d.,]+/g, \"\") // Remove price\n        .trim();\n\n        // Skip discount lines and empty colors\n        if (!itemCode.includes(\"Discount\") && color && !color.match(/^(ounce|oz|Bottle|Bottles)$/i)) {\n          results.push({\n            itemCode: itemCode.trim(),\n            color,\n            quantity,\n            size,\n            fulfilled: parseInt(fulfilled, 10),\n            invoiced: parseInt(invoiced, 10)\n          });\n          console.log('Successfully parsed item:', {\n            itemCode,\n            color,\n            quantity,\n            size\n          }); // Debug logging\n        }\n      } else {\n        console.log('Line did not match pattern:', line); // Debug logging\n      }\n    }\n    if (results.length === 0) {\n      console.error('No items could be parsed from the PDF');\n      throw new Error('No items could be parsed from the PDF');\n    }\n    console.log('Parsed results:', results); // Debug logging\n    return results;\n  } catch (error) {\n    console.error('Error parsing PDF:', error);\n    throw error;\n  }\n}","map":{"version":3,"names":["pdfjsLib","pdfWorker","GlobalWorkerOptions","workerSrc","parsePDFWorldFamous","arrayBuffer","pdf","getDocument","data","promise","allText","i","numPages","page","getPage","content","getTextContent","items","sort","a","b","yDiff","transform","Math","abs","currentY","currentLine","lines","item","length","push","join","str","split","filter","line","trim","match","console","log","results","replace","fulfilled","invoiced","qtyStr","itemCode","description","quantity","parseInt","size","sizeMatch","includes","color","error","Error"],"sources":["C:/Users/hongjie/Desktop/Warehouse Test/src/parsers/worldFamousParser.js"],"sourcesContent":["// src/parsers/worldFamousParser.js\r\nimport * as pdfjsLib from \"pdfjs-dist/build/pdf\";\r\nimport pdfWorker from \"pdfjs-dist/build/pdf.worker.entry\";\r\n\r\n// Ensure worker is properly configured\r\npdfjsLib.GlobalWorkerOptions.workerSrc = pdfWorker;\r\n\r\n/**\r\n * parsePDFWorldFamous(arrayBuffer)\r\n *  For World Famous / Ink Projects invoices\r\n */\r\nexport async function parsePDFWorldFamous(arrayBuffer) {\r\n  try {\r\n    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;\r\n    let allText = \"\";\r\n\r\n    for (let i = 1; i <= pdf.numPages; i++) {\r\n      const page = await pdf.getPage(i);\r\n      const content = await page.getTextContent();\r\n      \r\n      // Sort items by their vertical position (y) and then horizontal position (x)\r\n      const items = content.items.sort((a, b) => {\r\n        const yDiff = b.transform[5] - a.transform[5];\r\n        if (Math.abs(yDiff) < 2) { // If y positions are close, sort by x\r\n          return a.transform[4] - b.transform[4];\r\n        }\r\n        return yDiff;\r\n      });\r\n\r\n      // Group items by their vertical position to form lines\r\n      let currentY = null;\r\n      let currentLine = [];\r\n      const lines = [];\r\n\r\n      for (const item of items) {\r\n        if (currentY === null || Math.abs(item.transform[5] - currentY) > 2) {\r\n          if (currentLine.length > 0) {\r\n            lines.push(currentLine.join(' '));\r\n          }\r\n          currentLine = [item.str];\r\n          currentY = item.transform[5];\r\n        } else {\r\n          currentLine.push(item.str);\r\n        }\r\n      }\r\n      if (currentLine.length > 0) {\r\n        lines.push(currentLine.join(' '));\r\n      }\r\n\r\n      allText += lines.join('\\n') + '\\n';\r\n    }\r\n\r\n    // Split into lines and filter out empty lines and headers\r\n    const lines = allText.split('\\n')\r\n      .filter(line => line.trim())\r\n      .filter(line => !line.match(/^Page \\d+$/))\r\n      .filter(line => !line.match(/^(Item|Description|Ordered|Rate|Amount)$/))\r\n      .filter(line => !line.match(/^Total$/));\r\n\r\n    console.log('Filtered lines:', lines); // Debug logging\r\n    \r\n    const results = [];\r\n    \r\n    for (const line of lines) {\r\n      // Add debug logging to see exact line content with visible spaces\r\n      console.log('Processing line:', line.replace(/ /g, '·')); // Shows spaces as dots for debugging\r\n      \r\n      // Match World Famous invoice format from the actual invoice\r\n      // Example: \"0 0 10 WFFMW1 Mt. Fuji Mixing White— World Famous Tattoo Ink — 1oz\"\r\n      const match = line.match(/^\\s*(\\d+)\\s+(\\d+)\\s+(\\d+)\\s+([A-Z0-9]+)\\s+(.*?)(?:\\s+\\$[\\d.,]+){0,2}\\s*$/);\r\n      \r\n      if (match) {\r\n        const [, fulfilled, invoiced, qtyStr, itemCode, description] = match;\r\n        console.log('Matched components:', { fulfilled, invoiced, qtyStr, itemCode, description }); // Debug matched components\r\n        const quantity = parseInt(qtyStr.replace(/,/g, ''), 10);\r\n\r\n        // Extract size from description\r\n        let size = \"1oz\"; // default\r\n        const sizeMatch = description.match(/(?:^|\\s)(\\d+(?:\\/\\d+)?)\\s*(?:oz|ounce)(?:\\s|$)/i);\r\n        if (sizeMatch) {\r\n          size = sizeMatch[1] + \"oz\";\r\n        } else if (description.includes(\"2oz\")) {\r\n          size = \"2oz\";\r\n        } else if (description.includes(\"4oz\")) {\r\n          size = \"4oz\";\r\n        }\r\n\r\n        // Clean up color name\r\n        const color = description\r\n          .replace(/—\\s*World Famous Tattoo Ink(?:\\s*—)?/gi, \"\")\r\n          .replace(/\\s*—\\s*/g, \" \")  // Replace em dashes with spaces\r\n          .replace(/(?:^|\\s)(\\d+(?:\\/\\d+)?)\\s*(?:oz|ounce)(?:\\s|$)/gi, \" \")\r\n          .replace(/\\s*\\([^)]*\\)/g, \"\") // Remove any parenthetical notes\r\n          .replace(/\\s*\\[[^\\]]*\\]/g, \"\") // Remove any bracketed notes\r\n          .replace(/\\s*\\{[^}]*\\}/g, \"\") // Remove any curly braced notes\r\n          .replace(/\\s*\\$[\\d.,]+/g, \"\") // Remove price\r\n          .trim();\r\n\r\n        // Skip discount lines and empty colors\r\n        if (!itemCode.includes(\"Discount\") && color && !color.match(/^(ounce|oz|Bottle|Bottles)$/i)) {\r\n          results.push({\r\n            itemCode: itemCode.trim(),\r\n            color,\r\n            quantity,\r\n            size,\r\n            fulfilled: parseInt(fulfilled, 10),\r\n            invoiced: parseInt(invoiced, 10)\r\n          });\r\n          console.log('Successfully parsed item:', { itemCode, color, quantity, size }); // Debug logging\r\n        }\r\n      } else {\r\n        console.log('Line did not match pattern:', line); // Debug logging\r\n      }\r\n    }\r\n\r\n    if (results.length === 0) {\r\n      console.error('No items could be parsed from the PDF');\r\n      throw new Error('No items could be parsed from the PDF');\r\n    }\r\n\r\n    console.log('Parsed results:', results); // Debug logging\r\n    return results;\r\n  } catch (error) {\r\n    console.error('Error parsing PDF:', error);\r\n    throw error;\r\n  }\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}